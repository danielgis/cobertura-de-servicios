{"version":3,"sources":["../../../widgets/DynamicSearchWidgetCunaMas/Widget.js"],"names":["declare","BaseWidget","_WidgetsInTemplateMixin","WidgetManager","QueryTask","Query","Deferred","StatisticDefinition","fontAwesome","document","createElement","src","head","appendChild","isFirstLoad","baseClass","postCreate","inherited","arguments","map","on","executeZoomExtentInitial","bind","onClickGroup","evt","buildFormSearchCs","containerGroupsApCs","classList","toggle","containerFiltersApCs","onClickBack","destroyFormSearchCs","startup","onOpen","dojo","query","homeWidget","getInstance","getWidgetsByName","setExtent","homeDijit","extent","filters","config","groups","sort","a","b","index","containerBodyApCs","innerHTML","promise","Promise","resolve","forEach","filter","label","add","select","id","nameField","startupData","then","getDataByFilter","url","response","features","option","value","feature","attributes","catch","console","error","err","addEventListener","event","onChangeFilterCs","fields","where","deferred","queryTask","outFields","returnDistinctValues","execute","log","reject","currentFilterIndex","selectedIndex","target","selectedValue","options","currentFilter","isZoom","setExtentByPoint","filterAffected","affectedFilter","affectedIndex","affectedSelect","getElementById","defaultOption","text","firstOption","data","self","returnGeometry","executeForExtent"],"mappings":"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","file":"Widget.js","sourcesContent":["import declare from 'dojo/_base/declare';\r\nimport BaseWidget from 'jimu/BaseWidget';\r\nimport _WidgetsInTemplateMixin from 'dijit/_WidgetsInTemplateMixin';\r\nimport WidgetManager from \"jimu/WidgetManager\"\r\nimport QueryTask from \"esri/tasks/QueryTask\";\r\nimport Query from \"esri/tasks/query\";\r\nimport Deferred from \"dojo/Deferred\";\r\nimport StatisticDefinition from \"esri/tasks/StatisticDefinition\"\r\n\r\nconst fontAwesome = document.createElement('script');\r\nfontAwesome.src = 'https://use.fontawesome.com/releases/v5.3.1/js/all.js';\r\ndocument.head.appendChild(fontAwesome);\r\n\r\nlet isFirstLoad = false;\r\n\r\n// To create a widget, you need to derive from BaseWidget.\r\nexport default declare([BaseWidget], {\r\n\r\n  // Custom widget code goes here\r\n\r\n  baseClass: 'dynamic-search-widget-cuna-mas',\r\n\r\n  // add additional properties here\r\n\r\n  // methods to communication with app container:\r\n  postCreate() {\r\n    this.inherited(arguments);\r\n    this.map.on(\"update-end\", this.executeZoomExtentInitial.bind(this));\r\n  },\r\n\r\n  onClickGroup(evt) {\r\n    this.buildFormSearchCs();\r\n    this.containerGroupsApCs.classList.toggle('active');\r\n    this.containerFiltersApCs.classList.toggle('active');\r\n\r\n  },\r\n\r\n  onClickBack(evt) {\r\n    this.containerGroupsApCs.classList.toggle('active');\r\n    this.containerFiltersApCs.classList.toggle('active');\r\n    this.destroyFormSearchCs();\r\n  },\r\n\r\n  startup() {\r\n    this.inherited(arguments);\r\n  },\r\n  onOpen() {\r\n    dojo.query(\".groupFilterClsCs\").on('click', this.onClickGroup.bind(this));\r\n    dojo.query(\".backButtonClsCs\").on('click', this.onClickBack.bind(this));\r\n  },\r\n\r\n  executeZoomExtentInitial() {\r\n    if (isFirstLoad) {\r\n      return;\r\n    }\r\n    const homeWidget = WidgetManager.getInstance().getWidgetsByName(\"HomeButton\");\r\n    this.map.setExtent(homeWidget[0].homeDijit.extent);\r\n    isFirstLoad = true;\r\n  },\r\n\r\n  buildFormSearchCs() {\r\n    const filters = this.config.groups[0].filters;\r\n    filters.sort((a, b) => a.index - b.index);\r\n    this.containerBodyApCs.innerHTML = '';\r\n\r\n    let promise = Promise.resolve();\r\n\r\n    filters.forEach((filter, index) => {\r\n      const label = document.createElement('p');\r\n      label.classList.add('labelComboBoxClsCs');\r\n      label.innerHTML = filter.label;\r\n      this.containerBodyApCs.appendChild(label);\r\n\r\n      const select = document.createElement('select');\r\n      select.classList.add('comboBoxClsCs');\r\n      select.id = filter.nameField;\r\n      // if filter.startupData == true; when execute get data by filter\r\n      if (filter.startupData) {\r\n        promise = promise\r\n          .then(() => this.getDataByFilter(filter.url, [filter.nameField, filter.nameField]))\r\n          .then(response => {\r\n            response.features.forEach(feature => {\r\n              const option = document.createElement('option');\r\n              option.value = feature.attributes[filter.nameField];\r\n              option.innerHTML = feature.attributes[filter.nameField];\r\n              select.appendChild(option);\r\n            });\r\n          })\r\n          .catch(err => {\r\n            console.error('err', err);\r\n          });\r\n\r\n      };\r\n\r\n      select.addEventListener('change', (event) => this.onChangeFilterCs(event, index));\r\n      this.containerBodyApCs.appendChild(select);\r\n    });\r\n  },\r\n\r\n  // create function with name getDataByFilter with parameter url and optional parameter \"query\"\r\n  getDataByFilter(url, fields, where = \"1=1\") {\r\n    const deferred = new Deferred();\r\n    const queryTask = new QueryTask(url);\r\n    const query = new Query();\r\n    query.outFields = fields;\r\n    query.where = where;\r\n\r\n    query.returnDistinctValues = true;\r\n\r\n    queryTask.execute(query)\r\n      .then(response => {\r\n        console.log('response', response);\r\n        deferred.resolve(response);\r\n      })\r\n      .catch(err => {\r\n        console.error('err', err);\r\n        deferred.reject(err);\r\n      });\r\n    return deferred.promise;\r\n  },\r\n\r\n  onChangeFilterCs(evt, currentFilterIndex) {\r\n    const selectedIndex = evt.target.selectedIndex;\r\n    const selectedValue = evt.target.options[selectedIndex].value;\r\n    const currentFilter = this.config.groups[0].filters[currentFilterIndex];\r\n\r\n\r\n    let promise = Promise.resolve();\r\n\r\n    if (currentFilter.isZoom) {\r\n      promise = promise\r\n        .then(() => this.setExtentByPoint(currentFilter.url, `${currentFilter.nameField} = '${selectedValue}'`))\r\n        .catch(err => {\r\n          console.error('err', err);\r\n        });\r\n    }\r\n\r\n    if (!currentFilter.filterAffected) {\r\n      return;\r\n    }\r\n\r\n    // this.clearDependentCombos(currentFilterIndex);\r\n\r\n    // Procesa cada índice en `filterAffected`\r\n    currentFilter.filterAffected.forEach(affectedIndex => {\r\n      const affectedFilter = this.config.groups[0].filters[affectedIndex];\r\n      const affectedSelect = document.getElementById(affectedFilter.nameField);\r\n\r\n      // Limpia las opciones anteriores\r\n      affectedSelect.innerHTML = '';\r\n      const defaultOption = document.createElement('option');\r\n      defaultOption.text = affectedFilter.firstOption;\r\n      defaultOption.value = '';\r\n      affectedSelect.appendChild(defaultOption);\r\n\r\n      // Obtiene los datos filtrados y actualiza el combobox afectado\r\n      this.getDataByFilter(affectedFilter.url, [affectedFilter.nameField, affectedFilter.nameField], `${currentFilter.nameField} = '${selectedValue}'`)\r\n        .then(data => {\r\n          data.features.forEach(feature => {\r\n            const option = document.createElement('option');\r\n            option.value = feature.attributes[affectedFilter.nameField];\r\n            option.text = feature.attributes[affectedFilter.nameField];\r\n            affectedSelect.appendChild(option);\r\n          });\r\n        })\r\n        .catch(err => {\r\n          console.error(`Error al actualizar el filtro ${affectedFilter.label}:`, err);\r\n        });\r\n    });\r\n  },\r\n\r\n  setExtentByPoint(url, where) {\r\n    self = this;\r\n    const deferred = new Deferred();\r\n    const queryTask = new QueryTask(url);\r\n    const query = new Query();\r\n    query.where = where;\r\n    query.returnGeometry = true;\r\n    // query.outSpatialReference = this.map.spatialReference;\r\n    // query.returnExtentOnly = true;\r\n\r\n    queryTask.executeForExtent(query)\r\n      .then(response => {\r\n        console.log('response', response);\r\n        self.map.setExtent(response.extent);\r\n        // if (response.features.length === 1) {\r\n        // console\r\n        // return self.map.centerAndZoom(response.features[0].geometry, 15)\r\n        // } else {\r\n\r\n        // }\r\n\r\n      })\r\n      .then((response) => {\r\n        deferred.resolve(response);\r\n      })\r\n      .catch(err => {\r\n        console.error('err', err);\r\n        deferred.reject(err);\r\n      });\r\n    return deferred.promise;\r\n  },\r\n\r\n  destroyFormSearchCs() {\r\n    this.containerBodyApCs.innerHTML = '';\r\n  }\r\n  // onClose(){\r\n  //   console.log('DynamicSearchWidgetCunaMas::onClose');\r\n  // },\r\n  // onMinimize(){\r\n  //   console.log('DynamicSearchWidgetCunaMas::onMinimize');\r\n  // },\r\n  // onMaximize(){\r\n  //   console.log('DynamicSearchWidgetCunaMas::onMaximize');\r\n  // },\r\n  // onSignIn(credential){\r\n  //   console.log('DynamicSearchWidgetCunaMas::onSignIn', credential);\r\n  // },\r\n  // onSignOut(){\r\n  //   console.log('DynamicSearchWidgetCunaMas::onSignOut');\r\n  // }\r\n  // onPositionChange(){\r\n  //   console.log('DynamicSearchWidgetCunaMas::onPositionChange');\r\n  // },\r\n  // resize(){\r\n  //   console.log('DynamicSearchWidgetCunaMas::resize');\r\n  // }\r\n});\r\n"]}